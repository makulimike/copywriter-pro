{% extends "base.html" %}

{% block title %}{{ lead.name }} - Lead Details{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>Lead: {{ lead.name }}</h1>
    <a href="{{ url_for('campaign_detail', campaign_id=campaign.campaign_id) }}" class="btn btn-secondary">â† Back to Campaign</a>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Lead Information -->
    <div class="card">
        <h2 style="margin-bottom: 1.5rem;">ğŸ“‹ Lead Information</h2>
        
        <table style="width: 100%;">
            <tr><td style="padding: 0.5rem; font-weight: 600;">Name:</td><td>{{ lead.name }}</td></tr>
            <tr><td style="padding: 0.5rem; font-weight: 600;">Company:</td><td>{{ lead.company }}</td></tr>
            <tr><td style="padding: 0.5rem; font-weight: 600;">Industry:</td><td>{{ lead.industry or 'N/A' }}</td></tr>
            <tr><td style="padding: 0.5rem; font-weight: 600;">Location:</td><td>{{ lead.location or 'N/A' }}</td></tr>
            <tr><td style="padding: 0.5rem; font-weight: 600;">Country:</td><td>{{ lead.country or 'N/A' }}</td></tr>
            <tr><td style="padding: 0.5rem; font-weight: 600;">Rating:</td><td>{{ lead.rating }} â­ ({{ lead.total_ratings }} reviews)</td></tr>
            
            {% if lead.email %}
            <tr><td style="padding: 0.5rem; font-weight: 600;">Email:</td><td><a href="mailto:{{ lead.email }}">{{ lead.email }}</a></td></tr>
            {% endif %}
            
            {% if lead.phone %}
            <tr><td style="padding: 0.5rem; font-weight: 600;">Phone:</td><td><a href="tel:{{ lead.phone }}">{{ lead.phone }}</a></td></tr>
            {% endif %}
            
            {% if lead.facebook_url %}
            <tr><td style="padding: 0.5rem; font-weight: 600;">Facebook:</td><td><a href="{{ lead.facebook_url }}" target="_blank">{{ lead.facebook_url }}</a></td></tr>
            {% endif %}
            
            {% if lead.website %}
            <tr><td style="padding: 0.5rem; font-weight: 600;">Website:</td><td><a href="{{ lead.website }}" target="_blank">{{ lead.website }}</a></td></tr>
            {% endif %}
        </table>
        
        <div style="margin-top: 2rem;">
            <h3>Qualification Score: {{ lead.qualification_score }}/100</h3>
            <div style="background: #ecf0f1; height: 10px; border-radius: 5px;">
                <div style="background: {% if lead.qualification_score >= 70 %}#27ae60{% elif lead.qualification_score >= 40 %}#f39c12{% else %}#e74c3c{% endif %}; 
                             width: {{ lead.qualification_score }}%; height: 10px; border-radius: 5px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Actions -->
    <div>
        <!-- Quick Actions -->
        <div class="card" style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 1rem;">âš¡ Quick Actions</h2>
            
            {% if lead.email and 'email' in campaign.channels_enabled %}
            <button onclick="sendMessage('email')" class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;" id="emailBtn">
                ğŸ“§ Send Email
            </button>
            {% endif %}
            
            {% if lead.phone and 'whatsapp' in campaign.channels_enabled %}
            <button onclick="sendMessage('whatsapp')" class="btn btn-success" style="width: 100%; margin-bottom: 0.5rem;" id="whatsappBtn">
                ğŸ“± Send WhatsApp
            </button>
            {% endif %}
            
            {% if lead.facebook_url and 'facebook' in campaign.channels_enabled %}
            <button onclick="sendMessage('facebook')" class="btn btn-info" style="width: 100%; margin-bottom: 0.5rem;" id="facebookBtn">
                ğŸ‘¥ Send Facebook Message
            </button>
            {% endif %}
            
            {% if whatsapp_link %}
            <a href="{{ whatsapp_link }}" target="_blank" class="btn btn-success" style="width: 100%; margin-top: 0.5rem; display: block; text-align: center;">
                ğŸ“± WhatsApp Link
            </a>
            {% endif %}
            
            <div id="messageResult" style="margin-top: 1rem;"></div>
        </div>
        
        <!-- Message History -->
        <div class="card">
            <h2 style="margin-bottom: 1rem;">ğŸ“¨ Message History</h2>
            {% if messages %}
                {% for msg in messages %}
                <div style="border: 1px solid #ecf0f1; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>
                            {% if msg.channel == 'email' %}ğŸ“§ Email
                            {% elif msg.channel == 'whatsapp' %}ğŸ“± WhatsApp
                            {% elif msg.channel == 'facebook' %}ğŸ‘¥ Facebook
                            {% endif %}
                        </strong>
                        <span style="background: {% if msg.status == 'sent' %}#27ae60{% elif msg.status == 'failed' %}#e74c3c{% else %}#95a5a6{% endif %}; 
                                     color: white; padding: 0.2rem 0.5rem; border-radius: 4px;">
                            {{ msg.status }}
                        </span>
                    </div>
                    <p style="color: #7f8c8d; font-size: 0.9rem;">{{ msg.sent_at[:16] }}</p>
                    <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 4px; white-space: pre-wrap;">{{ msg.content }}</div>
                    
                    {% if msg.read_at %}
                    <p style="color: #27ae60; font-size: 0.8rem; margin-top: 0.5rem;">âœ“ Read at {{ msg.read_at[:16] }}</p>
                    {% endif %}
                    {% if msg.replied_at %}
                    <p style="color: #27ae60; font-size: 0.8rem;">â†©ï¸ Replied at {{ msg.replied_at[:16] }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p style="color: #7f8c8d; text-align: center;">No messages sent yet.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
function sendMessage(channel) {
    const btn = document.getElementById(channel + 'Btn');
    const result = document.getElementById('messageResult');
    
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Sending...';
    }
    result.innerHTML = '';
    
    fetch('/lead/{{ lead.lead_id }}/send-message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ channel: channel })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'sent') {
            result.innerHTML = '<div class="flash success">âœ… Message sent successfully!</div>';
            setTimeout(() => location.reload(), 1500);
        } else {
            result.innerHTML = '<div class="flash error">âŒ Failed to send message</div>';
            if (btn) {
                btn.disabled = false;
                btn.textContent = channel === 'email' ? 'ğŸ“§ Send Email' : 
                                 channel === 'whatsapp' ? 'ğŸ“± Send WhatsApp' : 'ğŸ‘¥ Send Facebook';
            }
        }
    })
    .catch(error => {
        result.innerHTML = '<div class="flash error">âŒ Error sending message</div>';
        if (btn) {
            btn.disabled = false;
            btn.textContent = channel === 'email' ? 'ğŸ“§ Send Email' : 
                             channel === 'whatsapp' ? 'ğŸ“± Send WhatsApp' : 'ğŸ‘¥ Send Facebook';
        }
    });
}
</script>
{% endblock %}